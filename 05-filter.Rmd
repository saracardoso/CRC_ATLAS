# Filter Cells and Genes


```{r echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, cache=FALSE}
library(ggraph)
library(patchwork)
# Before and After filtering merged datasets:
merge_before = read.csv('data/merge_before.csv', row.names=1)
merge_after = read.csv('data/merge_after.csv', row.names=1)
```



## Generate Quality Metrics

Seurat automatically calculates the number of UMIs per cell (variable `nUMI`) and the number of genes detected (i.e., without 0 counts) per cell (variable `nGene`). However, additional metrics were calculated to follow the criteria set in the beggining of chapter [2 Quality Control](#quality-control):

[**1.**]{style="color: black;"} Percentage of mitochondrial RNA

```{r eval=FALSE}
features = grep(pattern='^MT-', x=rownames(CRCatlas@assays$RNA@counts), value = TRUE)
percent.featureset = colSums(as.matrix(Seurat::GetAssayData(CRCatlas, assay='RNA', slot="counts")[features, , drop = FALSE]))/
  CRCatlas$nUMI * 100
CRCatlas[['percent.mitochondrial_RNA']] = percent.featureset
```

[**2.**]{style="color: black;"} Complexity

```{r eval=FALSE}
CRCatlas[['log10.complexity']] = log10(CRCatlas$nGene) / log10(CRCatlas$nUMI)
```

## Filter cells and genes

```{r eval=FALSE}
# Filter out low quality cells:
cells_keep = rownames(CRCatlas@meta.data)[(CRCatlas$nUMI >= 1000) &
                                            (CRCatlas$nGene >= 250) &
                                            (CRCatlas$nGene <= 6000) &
                                            (CRCatlas$log10.complexity > 0.80) &
                                            (CRCatlas$percent.mitochondrial_RNA <= 20)]
filtered_seurat = subset(CRCatlas, cells=cells_keep)

# Filter out low-expressed genes:
counts = Seurat::GetAssayData(object=filtered_seurat, slot="counts")
nonzero <- counts > 0
keep_genes <- Matrix::rowSums(nonzero) >= 10
filtered_counts <- counts[keep_genes, ]

# Creation of filtered dataset:
CRCatlas_filtered = Seurat::CreateSeuratObject(filtered_counts, meta.data=filtered_seurat@meta.data)

# Store this dataset
SeuratDisk::SaveH5Seurat(CRCatlas_filtered, paste(project_dir, '1_merge/CRC.h5Seurat', sep='/'))
```

## Check QC Plots

**Nº Cells per sample**

```{r eval=FALSE}
before = ggplot2::ggplot(CRCatlas@meta.data, ggplot2::aes(x=sample, fill=sample)) + 
  ggplot2::geom_bar() + ggplot2::theme_classic() +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, vjust = 1, hjust=1)) +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust=0.5, face="bold"), legend.position = "none") +
  ggplot2::ggtitle("Before") +
  ggplot2::ylim(c(0,5000))

after = ggplot2::ggplot(CRCatlas_filtered@meta.data, ggplot2::aes(x=sample, fill=sample)) + 
  ggplot2::geom_bar() + ggplot2::theme_classic() +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, vjust = 1, hjust=1)) +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust=0.5, face="bold"), legend.position = "none") +
  ggplot2::ggtitle("After") +
  ggplot2::ylim(c(0,5000))

before / after
```

```{r fig.width=15, fig.height=10, out.width='100%', warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}
before = ggplot2::ggplot(merge_before, ggplot2::aes(x=sample, fill=sample)) + 
  ggplot2::geom_bar() + ggplot2::theme_classic() +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, vjust = 1, hjust=1)) +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust=0.5, face="bold"), legend.position = "none") +
  ggplot2::ggtitle("Before") +
  ggplot2::ylim(c(0,5000))

after = ggplot2::ggplot(merge_after, ggplot2::aes(x=sample, fill=sample)) + 
  ggplot2::geom_bar() + ggplot2::theme_classic() +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, vjust = 1, hjust=1)) +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust=0.5, face="bold"), legend.position = "none") +
  ggplot2::ggtitle("After") +
  ggplot2::ylim(c(0,5000))

before
after
```

**Nº UMIs per cell**

```{r eval=FALSE}
before = ggplot2::ggplot(CRCatlas@meta.data, ggplot2::aes(x=nUMI, fill=sample)) + 
  ggplot2::geom_density(alpha = 0.2) + 
  ggplot2::scale_x_log10() + 
  ggplot2::theme_classic() +
  ggplot2::xlab('Nº UMIs') +
  ggplot2::ylab("Cell density") +
  ggplot2::geom_vline(xintercept = 1000) +
  ggplot2::ggtitle('Before') +
  ggplot2::theme(legend.position = "none") +
  ggplot2::ylim(c(0,4))

after = ggplot2::ggplot(CRCatlas_filtered@meta.data, ggplot2::aes(x=nUMI, fill=sample)) + 
  ggplot2::geom_density(alpha = 0.2) + 
  ggplot2::scale_x_log10() + 
  ggplot2::theme_classic() +
  ggplot2::xlab('Nº UMIs') +
  ggplot2::ylab("Cell density") +
  ggplot2::geom_vline(xintercept = 1000) +
  ggplot2::ggtitle('After') +
  ggplot2::theme(legend.position = "none") +
  ggplot2::ylim(c(0,4))

before | after
```

```{r fig.width=10, fig.height=5, out.width='100%', warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}
before = ggplot2::ggplot(merge_before, ggplot2::aes(x=nUMI, fill=sample)) + 
  ggplot2::geom_density(alpha = 0.2) + 
  ggplot2::scale_x_log10() + 
  ggplot2::theme_classic() +
  ggplot2::xlab('Nº UMIs') +
  ggplot2::ylab("Cell density") +
  ggplot2::geom_vline(xintercept = 1000) +
  ggplot2::ggtitle('Before') +
  ggplot2::theme(legend.position = "none") +
  ggplot2::ylim(c(0,4))

after = ggplot2::ggplot(merge_after, ggplot2::aes(x=nUMI, fill=sample)) + 
  ggplot2::geom_density(alpha = 0.2) + 
  ggplot2::scale_x_log10() + 
  ggplot2::theme_classic() +
  ggplot2::xlab('Nº UMIs') +
  ggplot2::ylab("Cell density") +
  ggplot2::geom_vline(xintercept = 1000) +
  ggplot2::ggtitle('After') +
  ggplot2::theme(legend.position = "none") +
  ggplot2::ylim(c(0,4))

before | after
```

**Nº Detected genes per cell**

```{r eval=FALSE}
before = ggplot2::ggplot(CRCatlas@meta.data, ggplot2::aes(x=nGene, fill=sample)) + 
  ggplot2::geom_density(alpha = 0.2) + 
  ggplot2::theme_classic() + ggplot2::xlab('Nº Genes') + ggplot2::ylab('Density') +
  ggplot2::scale_x_log10() + 
  ggplot2::geom_vline(xintercept = 250) +
  ggplot2::ggtitle('Before') +
  ggplot2::theme(legend.position = "none") +
  ggplot2::ylim(c(0,5))

after = ggplot2::ggplot(CRCatlas_filtered@meta.data, ggplot2::aes(x=nGene, fill=sample)) + 
  ggplot2::geom_density(alpha = 0.2) + 
  ggplot2::theme_classic() + ggplot2::xlab('Nº Genes') + ggplot2::ylab('Density') +
  ggplot2::scale_x_log10() + 
  ggplot2::geom_vline(xintercept = 250) +
  ggplot2::ggtitle('After') +
  ggplot2::theme(legend.position = "none") +
  ggplot2::ylim(c(0,5))

before | after
```

```{r fig.width=10, fig.height=5, out.width='100%', warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}
before = ggplot2::ggplot(merge_before, ggplot2::aes(x=nGene, fill=sample)) + 
  ggplot2::geom_density(alpha = 0.2) + 
  ggplot2::theme_classic() + ggplot2::xlab('Nº Genes') + ggplot2::ylab('Density') +
  ggplot2::scale_x_log10() + 
  ggplot2::geom_vline(xintercept = 250) +
  ggplot2::ggtitle('Before') +
  ggplot2::theme(legend.position = "none") +
  ggplot2::ylim(c(0,5))

after = ggplot2::ggplot(merge_after, ggplot2::aes(x=nGene, fill=sample)) + 
  ggplot2::geom_density(alpha = 0.2) + 
  ggplot2::theme_classic() + ggplot2::xlab('Nº Genes') + ggplot2::ylab('Density') +
  ggplot2::scale_x_log10() + 
  ggplot2::geom_vline(xintercept = 250) +
  ggplot2::ggtitle('After') +
  ggplot2::theme(legend.position = "none") +
  ggplot2::ylim(c(0,5))

before | after
```

**Distribution of genes detected per cell**

```{r eval=FALSE}
before = ggplot2::ggplot(CRCatlas@meta.data, ggplot2::aes(y=log10(nGene), fill=sample)) + 
  ggplot2::geom_boxplot() + 
  ggplot2::theme_classic() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust=0.5, face="bold")) +
  ggplot2::ggtitle('Before') +
  ggplot2::theme(legend.position = "none") +
  ggplot2::ylim(c(2.4,3.8))

after = ggplot2::ggplot(CRCatlas_filtered@meta.data, ggplot2::aes(y=log10(nGene), fill=sample)) + 
  ggplot2::geom_boxplot() + 
  ggplot2::theme_classic() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust=0.5, face="bold")) +
  ggplot2::ggtitle('After') +
  ggplot2::theme(legend.position = "none") +
  ggplot2::ylim(c(2.4,3.8))

before / after
```

```{r fig.width=10, fig.height=10, out.width='100%', warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}
before = ggplot2::ggplot(merge_before, ggplot2::aes(y=log10(nGene), fill=sample)) + 
  ggplot2::geom_boxplot() + 
  ggplot2::theme_classic() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust=0.5, face="bold")) +
  ggplot2::ggtitle('Before') +
  ggplot2::theme(legend.position = "none") +
  ggplot2::ylim(c(2.4,3.8))

after = ggplot2::ggplot(merge_after, ggplot2::aes(y=log10(nGene), fill=sample)) + 
  ggplot2::geom_boxplot() + 
  ggplot2::theme_classic() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust=0.5, face="bold")) +
  ggplot2::ggtitle('After') +
  ggplot2::theme(legend.position = "none") +
  ggplot2::ylim(c(2.4,3.8))

before / after
```

**UMIs vs Genes**

```{r eval=FALSE}
before = ggplot2::ggplot(CRCatlas@meta.data, ggplot2::aes(x=nUMI, y=nGene, color=percent.mitochondrial_RNA)) + 
  ggplot2::geom_point() + 
  ggplot2::scale_colour_gradient(low = "gray90", high = "black", limits=c(0,30)) +
  ggplot2::stat_smooth(method=lm) +
  ggplot2::scale_x_log10() + 
  ggplot2::scale_y_log10() + 
  ggplot2::theme_classic() +
  ggplot2::geom_vline(xintercept = 1000) +
  ggplot2::geom_hline(yintercept = 250) +
  ggplot2::xlab('Nº UMIs') + ggplot2::ylab('Nº Genes') +
  ggplot2::ggtitle('Before') +
  ggplot2::theme(legend.position = "bottom") +
  ggplot2::ylim(c(0,7500)) + ggplot2::xlim(c(0,80000))

after = ggplot2::ggplot(CRCatlas_filtered@meta.data, ggplot2::aes(x=nUMI, y=nGene, color=percent.mitochondrial_RNA)) + 
  ggplot2::geom_point() + 
  ggplot2::scale_colour_gradient(low = "gray90", high = "black", limits=c(0,30)) +
  ggplot2::stat_smooth(method=lm) +
  ggplot2::scale_x_log10() + 
  ggplot2::scale_y_log10() + 
  ggplot2::theme_classic() +
  ggplot2::geom_vline(xintercept = 1000) +
  ggplot2::geom_hline(yintercept = 250) +
  ggplot2::xlab('Nº UMIs') + ggplot2::ylab('Nº Genes') +
  ggplot2::ggtitle('After') +
  ggplot2::theme(legend.position = "bottom") +
  ggplot2::ylim(c(0,7500)) + ggplot2::xlim(c(0,80000))

before | after
```

```{r fig.width=10, fig.height=5, out.width='100%', warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}
before = ggplot2::ggplot(merge_before, ggplot2::aes(x=nUMI, y=nGene, color=percent.mitochondrial_RNA)) + 
  ggplot2::geom_point() + 
  ggplot2::scale_colour_gradient(low = "gray90", high = "black", limits=c(0,30)) +
  ggplot2::stat_smooth(method=lm) +
  ggplot2::scale_x_log10() + 
  ggplot2::scale_y_log10() + 
  ggplot2::theme_classic() +
  ggplot2::geom_vline(xintercept = 1000) +
  ggplot2::geom_hline(yintercept = 250) +
  ggplot2::xlab('Nº UMIs') + ggplot2::ylab('Nº Genes') +
  ggplot2::ggtitle('Before') +
  ggplot2::theme(legend.position = "bottom") +
  ggplot2::ylim(c(0,7500)) + ggplot2::xlim(c(0,80000))

after = ggplot2::ggplot(merge_after, ggplot2::aes(x=nUMI, y=nGene, color=percent.mitochondrial_RNA)) + 
  ggplot2::geom_point() + 
  ggplot2::scale_colour_gradient(low = "gray90", high = "black", limits=c(0,30)) +
  ggplot2::stat_smooth(method=lm) +
  ggplot2::scale_x_log10() + 
  ggplot2::scale_y_log10() + 
  ggplot2::theme_classic() +
  ggplot2::geom_vline(xintercept = 1000) +
  ggplot2::geom_hline(yintercept = 250) +
  ggplot2::xlab('Nº UMIs') + ggplot2::ylab('Nº Genes') +
  ggplot2::ggtitle('After') +
  ggplot2::theme(legend.position = "bottom") +
  ggplot2::ylim(c(0,7500)) + ggplot2::xlim(c(0,80000))

before | after
```

**Percentage of mitochondrial RNA per cell**

```{r eval=FALSE}
before = ggplot2::ggplot(CRCatlas@meta.data, ggplot2::aes(x=percent.mitochondrial_RNA, fill=sample)) + 
  ggplot2::geom_density(alpha = 0.2) + 
  ggplot2::scale_x_log10() + 
  ggplot2::theme_classic() +
  ggplot2::geom_vline(xintercept = 20) +
  ggplot2::ggtitle('Before') +
  ggplot2::theme(legend.position = "none") +
  ggplot2::ylim(c(0,.4)) + ggplot2::xlim(c(0,30))

after = ggplot2::ggplot(CRCatlas_filtered@meta.data, ggplot2::aes(x=percent.mitochondrial_RNA, fill=sample)) + 
  ggplot2::geom_density(alpha = 0.2) + 
  ggplot2::scale_x_log10() + 
  ggplot2::theme_classic() +
  ggplot2::geom_vline(xintercept = 20) +
  ggplot2::ggtitle('After') +
  ggplot2::theme(legend.position = "none") +
  ggplot2::ylim(c(0,.4)) + ggplot2::xlim(c(0,30))

before | after
```

```{r fig.width=10, fig.height=5, out.width='100%', warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}
before = ggplot2::ggplot(merge_before, ggplot2::aes(x=percent.mitochondrial_RNA, fill=sample)) + 
  ggplot2::geom_density(alpha = 0.2) + 
  ggplot2::scale_x_log10() + 
  ggplot2::theme_classic() +
  ggplot2::geom_vline(xintercept = 20) +
  ggplot2::ggtitle('Before') +
  ggplot2::theme(legend.position = "none") +
  ggplot2::ylim(c(0,.4)) + ggplot2::xlim(c(0,30))

after = ggplot2::ggplot(merge_after, ggplot2::aes(x=percent.mitochondrial_RNA, fill=sample)) + 
  ggplot2::geom_density(alpha = 0.2) + 
  ggplot2::scale_x_log10() + 
  ggplot2::theme_classic() +
  ggplot2::geom_vline(xintercept = 20) +
  ggplot2::ggtitle('After') +
  ggplot2::theme(legend.position = "none") +
  ggplot2::ylim(c(0,.4)) + ggplot2::xlim(c(0,30))

before | after
```

**Complexity**

```{r eval=FALSE}
before = ggplot2::ggplot(CRCatlas@meta.data, ggplot2::aes(x=log10.complexity, fill=sample)) +
  ggplot2::geom_density(alpha = 0.2) +
  ggplot2::theme_classic() +
  ggplot2::geom_vline(xintercept = 0.8) +
  ggplot2::ggtitle('Before') +
  ggplot2::theme(legend.position = "none") +
  ggplot2::ylim(c(0,30)) + ggplot2::xlim(c(.65,1))

after = ggplot2::ggplot(CRCatlas_filtered@meta.data, ggplot2::aes(x=log10.complexity, fill=sample)) +
  ggplot2::geom_density(alpha = 0.2) +
  ggplot2::theme_classic() +
  ggplot2::geom_vline(xintercept = 0.8) +
  ggplot2::ggtitle('After') +
  ggplot2::theme(legend.position = "none") +
  ggplot2::ylim(c(0,30)) + ggplot2::xlim(c(.65,1))

before | after
```

```{r fig.width=10, fig.height=5, out.width='100%', warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}
before = ggplot2::ggplot(merge_before, ggplot2::aes(x=log10.complexity, fill=sample)) +
  ggplot2::geom_density(alpha = 0.2) +
  ggplot2::theme_classic() +
  ggplot2::geom_vline(xintercept = 0.8) +
  ggplot2::ggtitle('Before') +
  ggplot2::theme(legend.position = "none") +
  ggplot2::ylim(c(0,30)) + ggplot2::xlim(c(.65,1))

after = ggplot2::ggplot(merge_after, ggplot2::aes(x=log10.complexity, fill=sample)) +
  ggplot2::geom_density(alpha = 0.2) +
  ggplot2::theme_classic() +
  ggplot2::geom_vline(xintercept = 0.8) +
  ggplot2::ggtitle('After') +
  ggplot2::theme(legend.position = "none") +
  ggplot2::ylim(c(0,30)) + ggplot2::xlim(c(.65,1))

before | after
```
